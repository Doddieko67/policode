# CLAUDE.md - Contexto del Proyecto PoliCode

## Informaci√≥n General del Proyecto
- **Nombre**: PoliCode
- **Tipo**: Aplicaci√≥n Flutter para la comunidad del IPN
- **Prop√≥sito**: Asistente del Reglamento Estudiantil con foro comunitario y chat IA
- **Backend**: Firebase (Firestore, Storage, Auth)
- **IA**: Flutter Gemini para chatbot

## Estructura del Proyecto

### Pantallas Principales
- `auth_screen.dart` - Autenticaci√≥n con Google
- `home_screen.dart` - Dashboard principal
- `chat_screen.dart` - Chat con IA especializada en reglamento
- `forum_screen.dart` - Foro de la comunidad
- `forum_post_detail_screen.dart` - Detalles de posts
- `create_post_screen.dart` - Crear posts
- `edit_post_screen.dart` - Editar posts
- `edit_reply_screen.dart` - **NUEVA** Editar respuestas con multimedia
- `mis_posts_screen.dart` - **NUEVA** Posts y respuestas del usuario
- `reglamentos_screen.dart` - Consulta de reglamentos
- `notas_screen.dart` - Sistema de notas

### Pantallas de Administraci√≥n (NUEVAS)
- `admin/admin_dashboard_screen.dart` - Panel principal de administraci√≥n
- `admin/reports_management_screen.dart` - Gesti√≥n de reportes
- `admin/regulations_management_screen.dart` - Gesti√≥n de reglamentos

### Servicios Principales
- `forum_service.dart` - **ACTUALIZADO** con m√©todos para IA y notificaciones
- `media_service.dart` - **ACTUALIZADO** con m√©todos multimedia
- `chatbot_service.dart` - **ACTUALIZADO** con contexto de posts
- `flutter_gemini_service.dart` - **ACTUALIZADO** con prompts combinados
- `auth_service.dart` - **ACTUALIZADO** con soporte para roles y OneSignal
- `admin_service.dart` - **NUEVO** Gesti√≥n de administraci√≥n
- `reglamento_service.dart` - Gesti√≥n del reglamento
- `push_notification_service.dart` - **NUEVO** FCM como respaldo
- `onesignal_service.dart` - **NUEVO** Servicio principal de notificaciones
- `notification_service.dart` - Gesti√≥n de notificaciones en BD

### Widgets Principales
- `forum_widgets.dart` - **ACTUALIZADO** con bot√≥n de reporte
- `media_widgets.dart` - Componentes multimedia interactivos
- `chat_components.dart` - **ACTUALIZADO** con posts relacionados
- `related_posts_widget.dart` - **NUEVO** Cards de posts relacionados
- `admin_guard.dart` - **NUEVO** Protecci√≥n de rutas admin
- `custom_cards.dart` - Cards reutilizables
- `loading_widgets.dart` - Estados de carga

## √öltimas Funcionalidades Implementadas

### 7. Sistema de Notificaciones Push con Firebase
**Estado**: ‚úÖ COMPLETADO - √öLTIMA IMPLEMENTACI√ìN
- **Servicios implementados**:
  - `PushNotificationService` - FCM directo (principal)
  - `NotificationService` - Gesti√≥n en base de datos
  - `Cloud Functions` - Trigger autom√°tico (opcional)
- **Integraci√≥n completa**:
  - Notificaciones autom√°ticas en likes de posts
  - Notificaciones autom√°ticas en respuestas a posts
  - Sistema directo (ForumService ‚Üí FCM)
  - Historial completo en Firestore
- **Gesti√≥n avanzada**:
  - Tokens FCM multi-dispositivo
  - Limpieza autom√°tica de tokens inv√°lidos
  - Badge count con notificaciones no le√≠das
  - Navegaci√≥n autom√°tica desde notificaciones
- **UX integrada**:
  - Pantalla de notificaciones nativa
  - Bot√≥n debug para ver token FCM
  - Logs detallados para troubleshooting
  - Sin dependencias externas

### 6. Panel de Administraci√≥n Completo
**Estado**: ‚úÖ COMPLETADO - √öLTIMA IMPLEMENTACI√ìN
- **Modelos nuevos**:
  - `user_model.dart` - Usuarios con roles y estados
  - `report_model.dart` - Sistema de reportes
- **AdminService**: Gesti√≥n completa de moderaci√≥n
  - Suspender/banear usuarios
  - Eliminar contenido reportado
  - Subir y gestionar reglamentos
  - Estad√≠sticas del sistema
- **Pantallas de admin** con protecci√≥n AdminGuard
- **Bot√≥n de reporte** en posts y respuestas
- **Acceso diferenciado**: Solo admins ven el bot√≥n Admin

### 1. Multimedia Completa en Respuestas del Foro
**Estado**: ‚úÖ COMPLETADO
- Las respuestas ahora soportan im√°genes, videos y documentos
- Cambio de `MediaPreview` (miniaturas) a `AttachmentsList` (completo)
- Funcionalidad id√©ntica a posts principales
- Galer√≠a de im√°genes con zoom
- Reproductores de video con controles
- Descarga de documentos

### 2. Pantalla de Edici√≥n de Respuestas
**Estado**: ‚úÖ COMPLETADO
- `edit_reply_screen.dart` - Pantalla completa para editar respuestas
- Similar a `create_post_screen.dart` en funcionalidad
- Gesti√≥n completa de archivos multimedia:
  - Ver archivos existentes
  - Eliminar archivos
  - Agregar nuevos archivos
- Navegaci√≥n desde `forum_post_detail_screen.dart`

### 3. Eliminaci√≥n de Chat Privado
**Estado**: ‚úÖ COMPLETADO
- Eliminados archivos:
  - `private_chat_screen.dart`
  - `chats_list_screen.dart`
  - `private_chat_service.dart`
  - `private_chat_model.dart`
- Reemplazado bot√≥n "Chats" por "Mis posts" en `home_screen.dart`

### 4. Pantalla "Mis Posts"
**Estado**: ‚úÖ COMPLETADO
- `mis_posts_screen.dart` - Muestra posts y respuestas del usuario
- Dos pesta√±as: "Mis Posts" y "Mis Respuestas"
- Navegaci√≥n desde respuestas al post original
- Refresh y like functionality
- Ruta agregada en `main.dart`: `/mis-posts`

### 5. IA con Contexto de Posts del Foro
**Estado**: ‚úÖ COMPLETADO - √öLTIMA IMPLEMENTACI√ìN
- **ForumService actualizado** con m√©todos para IA:
  - `searchPostsForAI()` - B√∫squeda inteligente de posts
  - `generarContextoPostsParaIA()` - Contexto para Gemini
  - Scoring por relevancia en t√≠tulo, contenido, tags
- **FlutterGeminiService actualizado**:
  - `askAboutReglamentoAndForum()` - M√©todo combinado
  - `_buildCombinedPrompt()` - Prompt que prioriza reglamento
- **ChatbotService actualizado**:
  - Integra contexto de reglamento + foro
  - Retorna posts relacionados en metadata
- **RelatedPostsWidget**: Cards detallados de posts relacionados
- **ChatBubble actualizado**: Muestra posts relacionados junto a art√≠culos

## Comandos de Desarrollo

### Compilaci√≥n
```bash
flutter build apk --debug  # Para testing
flutter build apk --release  # Para producci√≥n
```

### An√°lisis
```bash
flutter analyze  # Verificar errores
```

### Testing
- Los logs est√°n habilitados en `forum_service.dart` para debug
- Quitar logs cuando sea necesario

## Estado Actual del Proyecto

### ‚úÖ Funcionalidades Completadas
1. **Foro completo** con multimedia en posts y respuestas
2. **Sistema de edici√≥n** avanzado para posts y respuestas
3. **Chat IA** con contexto de reglamento Y posts del foro
4. **Cards de posts relacionados** en respuestas de IA
5. **Navegaci√≥n fluida** entre chat ‚Üí foro ‚Üí posts espec√≠ficos
6. **Pantalla "Mis Posts"** con navegaci√≥n a discusiones
7. **Panel de Administraci√≥n** completo con:
   - Dashboard con estad√≠sticas
   - Gesti√≥n de reportes y moderaci√≥n
   - Subida y edici√≥n de reglamentos
   - Acciones de suspensi√≥n/baneo
   - Protecci√≥n con AdminGuard
8. **Sistema de Notificaciones Push** completo con:
   - Firebase Cloud Messaging (FCM) como servicio principal
   - Cloud Functions como alternativa opcional
   - Notificaciones autom√°ticas en likes y respuestas
   - Gesti√≥n autom√°tica de tokens FCM
   - Historial completo en base de datos
   - Sistema de limpieza de tokens inv√°lidos

### üîÑ En Progreso
- Ninguna tarea pendiente espec√≠fica

### üìã Posibles Mejoras Futuras
1. Sistema de moderaci√≥n avanzado
2. B√∫squeda avanzada en el foro
3. Estad√≠sticas de usuario
4. Modo offline
5. Notificaciones programadas
6. Segmentaci√≥n de notificaciones por categor√≠as

## Configuraci√≥n Importante

### Firebase
- Configurado en `firebase_options.dart`
- Collections principales:
  - `forum_posts` - Posts del foro
  - `forum_replies` - Respuestas
  - `forum_likes` - Likes de posts
  - `forum_reply_likes` - Likes de respuestas
  - `users` - Usuarios con roles y permisos
  - `reports` - Reportes de contenido
  - `regulations` - Reglamentos del sistema
  - `admin_logs` - Logs de acciones administrativas

### Gemini IA
- Configurado en `main.dart`
- API Key en `.env`
- Modelo: `gemini-2.0-flash`
- Contexto combinado: reglamento + posts

### Notificaciones Push
- **Firebase FCM**: Servicio principal
- **Cloud Functions**: Triggers autom√°ticos (opcional)
- **Configuraci√≥n**: Autom√°tica via `google-services.json`
- **Collections**: 
  - `notifications` - Historial completo
  - `users` - Tokens FCM en campo `fcmTokens`
- **Documentaci√≥n**: Ver `FIREBASE_FUNCTIONS_NOTIFICATIONS.md`

### Rutas Principales
```dart
'/': AppInitializer
'/home': HomeScreen
'/chat': ChatScreen
'/forum': ForumScreen
'/create-post': CreatePostScreen
'/mis-posts': MisPostsScreen
'/reglamentos': ReglamentosScreen
'/notas': NotasScreen
// Rutas admin (protegidas)
'/admin': AdminDashboardScreen
'/admin/reports': ReportsManagementScreen
'/admin/regulations': RegulationsManagementScreen
```

## Notas de Desarrollo

### √öltimos Cambios Importantes
1. **Multimedia**: Cambiado `MediaPreview` ‚Üí `AttachmentsList` en respuestas
2. **Navegaci√≥n**: "Mis respuestas" ahora llevan al post espec√≠fico
3. **IA**: Combina reglamento oficial + discusiones comunitarias
4. **UX**: Cards interactivos para posts relacionados

### Patrones Establecidos
- Usar `AttachmentsList` para multimedia completa
- Usar `MediaPreview` solo para vistas compactas
- Mantener separaci√≥n entre informaci√≥n oficial (reglamento) y comunitaria (foro)
- Logs de debug en servicios para troubleshooting

### Arquitectura de IA
- **Prioridad 1**: Reglamento oficial (fuente autoritativa)
- **Prioridad 2**: Posts del foro (contexto y ejemplos)
- **UI**: Cards distinguibles (primario para reglamento, secundario para foro)
- **Navegaci√≥n**: Flujo chat ‚Üí post espec√≠fico

---

## Para la Pr√≥xima Sesi√≥n

Cuando retomes el proyecto, ejecuta:
```bash
flutter analyze
flutter build apk --debug
```

Y revisa que todas las funcionalidades est√©n operativas:
1. Chat IA con posts relacionados
2. Creaci√≥n/edici√≥n de posts y respuestas con multimedia
3. Navegaci√≥n "Mis Posts" ‚Üí post espec√≠fico
4. Multimedia interactiva en todas las respuestas

**Estado del proyecto**: Estable y completamente funcional con sistema de administraci√≥n ‚úÖ

### Notas importantes sobre roles:
- Por defecto, todos los usuarios nuevos tienen rol 'user'
- Para hacer a alguien admin, actualizar manualmente en Firestore:
  - Colecci√≥n `users` > documento del usuario > campo `role: 'admin'`
- Los admins pueden:
  - Ver panel de administraci√≥n
  - Gestionar reportes
  - Suspender/banear usuarios
  - Eliminar contenido
  - Subir/editar reglamentos